<!DOCTYPE HTML>
<html>

    <head>

        <!-- JQuery -->
        <script src="jquery-3.7.1.min.js"></script>

        <!-- JavaScript CDG handling script -->
        <script src="wcdg.js"></script>

        <title>Karaoke Room</title>

    </head>

    <body style="background-color: black;">

        <center>
            <!-- The Karaoke part -->
            <div id="karaoke-player">
                <canvas id="karaoke-display" width="900" height="650" style="background: url('player.png'); border-color: aqua; border-style: dotted; align-content: center;"></canvas>
                <audio id="song" autoplay>
                    <source src="" type="audio/mpeg" />
                </audio>    
            </div>

            <!-- Divider -->
            <hr>

            <!-- The Information -->
            <div width="900" height="250">
                <table style="border: 1px solid #4176e7;">
                    <tr style="color: magenta;">
                        <td rowspan="10" width="300">
                            <img src="iSing.png" height="150" width="150">
                        </td>
                        <td style="font-size: larger;" width="250">
                            Current Singer(s):
                        </td>
                        <td id="current-singer" width="350"></td>
                    </tr>
                    <tr style="color: cyan;">
                        <td style="font-size: larger;">
                            Artist Name:
                        </td>
                        <td id="artist-name"></td>
                    </tr>
                    <tr style="color: cyan;">
                        <td style="font-size: larger;">
                            Song Name:
                        </td>
                        <td id="song-name"></td>
                    </tr>
                    <tr style="color: green;">
                        <td style="font-size: larger;">
                            Genre:
                        </td>
                        <td id="song-genre"></td>
                    </tr>
                    <tr style="color: green;">
                        <td style="font-size: larger;">
                            Tone:
                        </td>
                        <td id="song-tone"></td>
                    </tr>
                    <tr style="color: yellow;">
                        <td style="font-size: larger;">
                            Language:
                        </td>
                        <td id="song-language"></td>
                    </tr>
                </table>
            </div>

        </center>

        <!-- Handle the Server Side Events -->
        <script>
            // Define the cdg player + load song
            var player = new CDGPlayer(document.getElementById('karaoke-display'));
            
            // Define the audio to play
            var audio = document.getElementById('song');

            // Define an Event Source to use that points to our php server
            const eventSource = new EventSource( "server.php" );

            // Define an Event Listener for new songs
            eventSource.addEventListener( "new_song", function( event ){
                // Explode the data received into an array
                var data = event.data.split("|");

                // Populate the panel information
                document.querySelector("#current-singer").innerHTML = data[0];
                document.querySelector("#artist-name").innerHTML = data[1];
                document.querySelector("#song-name").innerHTML = data[2];
                document.querySelector("#song-genre").innerHTML = data[3];
                document.querySelector("#song-tone").innerHTML = data[4];
                document.querySelector("#song-language").innerHTML = data[5];

                // Load the appropriate song information
                player.load( data[6] );
                audio.src = data[7];

                // Start playing
                play();
            } );

            function play(){
                // Start playing
                audio.play();
                player.play();
                
                // Simulate a click to enable audio
                document.getElementById( 'karaoke-display' ).click();
            }
        </script>

    </body>
</html>